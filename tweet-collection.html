<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="tweet-item.html">

<polymer-element name="tweet-collection" attributes="q">

<template>
  <link rel="stylesheet" href="tweet-collection.css">

  <div horizontal layout>
    <div>
      <template repeat="{{ item in items }}">
        <template if="{{ ! item.retweeted_status }}">
          <tweet-item item="{{ item }}"></tweet-item>
        </template>
      </template>
      
      <template if="{{ loading }}">
        <div id="loading">loading&hellip;</div>
      </template>
    
      <template if="{{ next_results }}">
        <a id="more" href="{{ next_results }}" on-click="{{ loadMore }}">load more</a>
      </template>
    </div>

    <div flex>
      <template repeat="{{ item in items }}">
        <template if="{{ item.retweeted_status }}">
          <tweet-item item="{{ item }}"></tweet-item>
        </template>
      </template>
    </div>
  </div>

  <core-ajax
    auto
    url="http://www.macropus.org/twitter/"
    params="{{ params }}"
    handleAs="json"
    on-core-response="{{handleResponse}}"></core-ajax>
</template>

<script>
Polymer('tweet-collection', {
  q: '',
  loading: true,
  next_results: null,
  refresh_url: null,
  ready: function() {
    this.params = { q: this.q };
    this.items = [];
  },
  handleResponse: function(event, details, target) {
    var response = details.response;

    var refreshing = !this.loading;
    this.loading = false;

    if (!response.statuses) {
      return;
    }

    if (refreshing) {
      response.statuses.reverse();
    }

    response.statuses.forEach(function(status) {
      if (refreshing) {
        this.items.unshift(status);
      } else {
        this.items.push(status);
      }
    }.bind(this));

    if (refreshing || !this.refresh_url) {
      this.refresh_url = response.search_metadata.refresh_url;

      if (this.refresh_url) {
        window.setTimeout(this.refresh.bind(this), 60000);
      }
    }

    if (!refreshing) {
      this.next_results = response.search_metadata.next_results;
    }
  },
  loadMore: function(event) {
    event.preventDefault();
    this.loading = true;
    this.params = (new URL('http://example.com/' + this.next_results)).params();
    this.next_results = false;
  },
  refresh: function() {
    this.params = (new URL('http://example.com/' + this.refresh_url)).params();;
    this.refresh_url = false;
  }
})
</script>

</polymer-element>
