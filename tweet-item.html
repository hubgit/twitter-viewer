<link rel="import" href="bower_components/polymer/polymer.html">

<polymer-element name="tweet-item" attributes="item">

<template>
  <link rel="stylesheet" href="tweet-item.css">

  <div class="tweet {{ { retweet: item.retweeted_status } | tokenList }}" horizontal layout>
    <div id="profile-image"><a target="_blank" href="https://twitter.com/{{ item.user.screen_name }}"><img src="{{ item.user.profile_image_url_https }}"></a></div>

    <div id="main" flex>
      <div class="meta"><a target="_blank" href="https://twitter.com/{{ item.user.screen_name }}"><span class="user">{{ item.user.screen_name }}</span> (<span class="followers">{{ item.user.followers_count }}</span>)</a> <a target="_blank" href="https://twitter.com/{{ item.user.screen_name }}/status/{{ item.id_str }}"><time id="created" datetime="{{ item.created_at }}">{{ item.created_relative }}</time></a></div>

      <template if="{{ item.retweeted_status }}">
      <div class="meta">RT <a target="_blank" href="https://twitter.com/{{ item.retweeted_status.user.screen_name }}"><span class="user">{{ item.retweeted_status.user.screen_name }}</span> (<span class="followers">{{ item.retweeted_status.user.followers_count }}</span>)</a> <a target="_blank" href="https://twitter.com/{{ item.retweeted_status.user.screen_name }}/status/{{ item.retweeted_status.id_str }}"><time id="created" datetime="{{ item.retweeted_status.created_at }}">{{ item.retweeted_status.created_relative }}</time></a></div>
      </template>

      <template if="{{ item.retweeted_status }}"><div id="text">{{ item.retweeted_status.text }}</div></template>
      <template if="{{ !item.retweeted_status }}"><div id="text">{{ item.text }}</div></template>

      <div class="meta">
        <template if="{{ item.retweet_count && !item.retweeted_status }}">
          <span class="retweets">{{ item.retweet_count }} RT</span>
        </template>

        <template if="{{ item.favorite_count }}">
          <span class="favorites">{{ item.favorite_count }} â˜…</span>
        </template>
      </div>
    </div>
  </div>
</template>

<script>
Polymer('tweet-item', {
  itemChanged: function() {
    this.item.created_relative = moment(this.item.created_at).fromNow();

    if (this.item.retweeted_status) {
      this.item.retweeted_status.created_relative = moment(this.item.retweeted_status.created_at).fromNow();
    }
  },
  domReady: function() {
    this.wrapEntities();
  },
  wrapEntities: function() {
    var node = this.shadowRoot.querySelector('#text').firstChild;
    var entities = this.item.retweeted_status ? this.item.retweeted_status.entities : this.item.entities;

    var items = [];

    if (entities.urls) {
      entities.urls.forEach(function(entity) {
        items.push(entity);
      });
    }

    if (entities.media) {
      entities.media.forEach(function(entity) {
        items.push(entity);
      });
    }

    items.sort(function(a, b) {
      return b.indices[0] - a.indices[0];
    });

    items.forEach(function(entity) {
      this.replaceWithLink(node, entity.indices[0], entity.indices[1], entity.expanded_url, entity.display_url)
    }.bind(this));
  },
  replaceWithLink: function(node, startOffset, endOffset, url, text) {
    var link = document.createElement('a');
    link.href = url;
    link.textContent = text;
    link.setAttribute('target', '_blank');

    var range = document.createRange();
    range.setStart(node, startOffset);
    range.setEnd(node, endOffset);
    range.deleteContents();
    range.insertNode(link);
  }
})
</script>

</polymer-element>
